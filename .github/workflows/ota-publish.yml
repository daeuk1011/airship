name: OTA Publish

on:
  workflow_dispatch:
    inputs:
      appKey:
        description: "App key"
        required: true
        type: string
      runtimeVersion:
        description: "Runtime version (e.g. 1.0.0)"
        required: true
        type: string
      platform:
        description: "Platform"
        required: true
        type: choice
        options:
          - both
          - ios
          - android
      iosBundlePath:
        description: "iOS bundle file path"
        required: false
        type: string
        default: "dist/bundles/ios.js"
      androidBundlePath:
        description: "Android bundle file path"
        required: false
        type: string
        default: "dist/bundles/android.js"
      channel:
        description: "Target channel"
        required: false
        default: "staging"
        type: string

jobs:
  resolve-platforms:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set platform matrix
        id: set-matrix
        env:
          INPUT_PLATFORM: ${{ inputs.platform }}
          INPUT_IOS_BUNDLE: ${{ inputs.iosBundlePath }}
          INPUT_ANDROID_BUNDLE: ${{ inputs.androidBundlePath }}
        run: |
          if [ "$INPUT_PLATFORM" = "both" ]; then
            echo "matrix={\"include\":[{\"platform\":\"ios\",\"bundle\":\"$INPUT_IOS_BUNDLE\"},{\"platform\":\"android\",\"bundle\":\"$INPUT_ANDROID_BUNDLE\"}]}" >> "$GITHUB_OUTPUT"
          elif [ "$INPUT_PLATFORM" = "ios" ]; then
            echo "matrix={\"include\":[{\"platform\":\"ios\",\"bundle\":\"$INPUT_IOS_BUNDLE\"}]}" >> "$GITHUB_OUTPUT"
          else
            echo "matrix={\"include\":[{\"platform\":\"android\",\"bundle\":\"$INPUT_ANDROID_BUNDLE\"}]}" >> "$GITHUB_OUTPUT"
          fi

  publish:
    needs: resolve-platforms
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix: ${{ fromJson(needs.resolve-platforms.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify bundle file exists
        env:
          BUNDLE_FILE: ${{ matrix.bundle }}
        run: |
          if [ ! -f "$BUNDLE_FILE" ]; then
            echo "Error: Bundle file not found: $BUNDLE_FILE"
            exit 1
          fi

      - name: Publish OTA update
        env:
          AIRSHIP_ADMIN_SECRET: ${{ secrets.AIRSHIP_ADMIN_SECRET }}
          AIRSHIP_SERVER_URL: ${{ secrets.AIRSHIP_SERVER_URL }}
          INPUT_APP_KEY: ${{ inputs.appKey }}
          INPUT_RUNTIME_VERSION: ${{ inputs.runtimeVersion }}
          INPUT_PLATFORM: ${{ matrix.platform }}
          INPUT_BUNDLE: ${{ matrix.bundle }}
          INPUT_CHANNEL: ${{ inputs.channel }}
        run: |
          ./scripts/publish-update.sh \
            --app-key "$INPUT_APP_KEY" \
            --runtime-version "$INPUT_RUNTIME_VERSION" \
            --platform "$INPUT_PLATFORM" \
            --bundle "$INPUT_BUNDLE" \
            --channel "$INPUT_CHANNEL"
