# Production Operations Checklist

## 1) Health Check Monitoring

- Health endpoint: `GET /`
- Interval: 1 minute
- Alert condition: 3 consecutive failures

```bash
curl -fsS http://localhost/ >/dev/null && echo "ok" || echo "failed"
```

## 2) CloudWatch Alarms

Set variables once:

```bash
AWS_REGION=ap-northeast-2
INSTANCE_ID=i-xxxxxxxxxxxxxxxxx
SNS_TOPIC_ARN=arn:aws:sns:ap-northeast-2:123456789012:airship-alerts
```

CPU alarm (>= 80%, 5 minutes):

```bash
aws cloudwatch put-metric-alarm \
  --region "$AWS_REGION" \
  --alarm-name "airship-ec2-cpu-high" \
  --alarm-description "EC2 CPU >= 80% for 5 minutes" \
  --namespace AWS/EC2 \
  --metric-name CPUUtilization \
  --dimensions Name=InstanceId,Value="$INSTANCE_ID" \
  --statistic Average \
  --period 300 \
  --evaluation-periods 1 \
  --threshold 80 \
  --comparison-operator GreaterThanOrEqualToThreshold \
  --alarm-actions "$SNS_TOPIC_ARN"
```

Instance status check alarm:

```bash
aws cloudwatch put-metric-alarm \
  --region "$AWS_REGION" \
  --alarm-name "airship-ec2-status-check-failed" \
  --alarm-description "EC2 status check failed" \
  --namespace AWS/EC2 \
  --metric-name StatusCheckFailed_Instance \
  --dimensions Name=InstanceId,Value="$INSTANCE_ID" \
  --statistic Maximum \
  --period 60 \
  --evaluation-periods 1 \
  --threshold 1 \
  --comparison-operator GreaterThanOrEqualToThreshold \
  --alarm-actions "$SNS_TOPIC_ARN"
```

Disk usage alarm:

```bash
aws cloudwatch put-metric-alarm \
  --region "$AWS_REGION" \
  --alarm-name "airship-disk-used-high" \
  --alarm-description "Disk used percent >= 85" \
  --namespace CWAgent \
  --metric-name disk_used_percent \
  --dimensions Name=InstanceId,Value="$INSTANCE_ID" Name=path,Value=/home/ec2-user/data Name=fstype,Value=ext4 \
  --statistic Average \
  --period 300 \
  --evaluation-periods 1 \
  --threshold 85 \
  --comparison-operator GreaterThanOrEqualToThreshold \
  --alarm-actions "$SNS_TOPIC_ARN"
```

## 3) Container Runtime Checks

배포 후 확인:

```bash
docker ps --filter name=airship
docker inspect -f '{{.State.Status}} restart={{.RestartCount}}' airship
docker logs --tail=200 airship
```

Alert 조건:
- `airship` 컨테이너 미실행
- Restart count 지속 증가
- 마이그레이션/DB 쓰기 에러 반복

## 4) OTA Rollback Runbook

### 대시보드를 통한 OTA 롤백

특정 업데이트에 문제가 발생한 경우:

1. **즉시 비활성화**: Update 상세 → **Disable Update** 클릭 (매니페스트에서 즉시 제외)
2. **롤백 실행**: 이전 정상 업데이트의 상세 페이지에서 Rollback 섹션 사용
3. **롤아웃 비율 조절**: Channels 페이지에서 해당 채널의 롤아웃을 0%로 낮춰 긴급 차단 가능

### 서버 롤백

릴리스 전 이전 이미지 태그를 기록해두세요.

```bash
ECR_REGISTRY=<account>.dkr.ecr.ap-northeast-2.amazonaws.com
PREV_TAG=<previous-git-sha>

docker pull "$ECR_REGISTRY/airship:$PREV_TAG"
docker stop airship || true
docker rm airship || true
docker run -d --name airship --restart unless-stopped \
  -p 80:3000 \
  --env-file /home/ec2-user/.env \
  -v /home/ec2-user/data:/app/data \
  "$ECR_REGISTRY/airship:$PREV_TAG"
```

서버 롤백 트리거:
- Health check 5분 이상 실패
- 배포 후 5xx 급증
- 시작 시 마이그레이션 실패

## 5) API Token Rotation

API Token 교체 절차:

1. 대시보드 **Tokens** 페이지에서 새 토큰 생성
2. CI/CD secrets에 새 토큰 값 업데이트
3. 새 토큰으로 API 호출 정상 확인 후 이전 토큰 **Revoke**

> API Token은 생성 시 한 번만 표시됩니다. 즉시 CI secrets에 저장하세요.

## 6) App Cleanup

더 이상 사용하지 않는 앱 정리:

1. 앱 상세 페이지에서 **Delete App** 클릭
2. 확인 다이얼로그에서 삭제 승인
3. DB의 모든 관련 데이터(업데이트, 채널, 할당, 에셋, 롤백 히스토리)가 cascade 삭제됨

> S3 오브젝트는 자동 삭제되지 않습니다. 필요 시 수동으로 S3 버킷을 정리하세요.
