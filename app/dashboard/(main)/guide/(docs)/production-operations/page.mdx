# Production Operations

Monitoring, alarms, and rollback procedures for AWS EC2 deployments.

---

## 1. Health Check

- **Endpoint**: `GET /`
- **Interval**: every 1 minute
- **Alert**: after 3 consecutive failures

```bash
curl -fsS http://localhost/ >/dev/null && echo "ok" || echo "failed"
```

---

## 2. CloudWatch Alarms

Set common variables first:

```bash
AWS_REGION=ap-northeast-2
INSTANCE_ID=i-xxxxxxxxxxxxxxxxx
SNS_TOPIC_ARN=arn:aws:sns:ap-northeast-2:123456789012:airship-alerts
```

### CPU (>= 80% for 5 min)

```bash
aws cloudwatch put-metric-alarm \
  --region "$AWS_REGION" \
  --alarm-name "airship-ec2-cpu-high" \
  --alarm-description "EC2 CPU >= 80% for 5 minutes" \
  --namespace AWS/EC2 \
  --metric-name CPUUtilization \
  --dimensions Name=InstanceId,Value="$INSTANCE_ID" \
  --statistic Average --period 300 --evaluation-periods 1 \
  --threshold 80 --comparison-operator GreaterThanOrEqualToThreshold \
  --alarm-actions "$SNS_TOPIC_ARN"
```

### Instance Status Check

```bash
aws cloudwatch put-metric-alarm \
  --region "$AWS_REGION" \
  --alarm-name "airship-ec2-status-check-failed" \
  --alarm-description "EC2 status check failed" \
  --namespace AWS/EC2 \
  --metric-name StatusCheckFailed_Instance \
  --dimensions Name=InstanceId,Value="$INSTANCE_ID" \
  --statistic Maximum --period 60 --evaluation-periods 1 \
  --threshold 1 --comparison-operator GreaterThanOrEqualToThreshold \
  --alarm-actions "$SNS_TOPIC_ARN"
```

### Disk (>= 85%)

Requires CloudWatch Agent:

```bash
aws cloudwatch put-metric-alarm \
  --region "$AWS_REGION" \
  --alarm-name "airship-disk-used-high" \
  --alarm-description "Disk used percent >= 85" \
  --namespace CWAgent \
  --metric-name disk_used_percent \
  --dimensions Name=InstanceId,Value="$INSTANCE_ID" \
    Name=path,Value=/home/ec2-user/data Name=fstype,Value=ext4 \
  --statistic Average --period 300 --evaluation-periods 1 \
  --threshold 85 --comparison-operator GreaterThanOrEqualToThreshold \
  --alarm-actions "$SNS_TOPIC_ARN"
```

---

## 3. Container Status

Run after each deployment:

```bash
docker ps --filter name=airship
docker inspect -f '{{.State.Status}} restart={{.RestartCount}}' airship
docker logs --tail=200 airship
```

**Alert conditions**: container not running / restart count keeps increasing / repeated DB errors

---

## 4. OTA Rollback

When a problematic update is discovered, you can respond **immediately from the dashboard**.

### Emergency Block

| Method | Location | Effect |
|---|---|---|
| **Disable Update** | Update detail | Immediately excluded from manifest responses |
| **Rollout 0%** | Channels page | Completely stops delivery for the channel |

### Roll Back to Previous Version

1. Navigate to the detail page of a known-good previous update
2. Use the **Rollback** section to select the channel and execute

### Server Rollback

Record the previous image tag before each release.

```bash
ECR_REGISTRY=<account>.dkr.ecr.ap-northeast-2.amazonaws.com
PREV_TAG=<previous-git-sha>

docker pull "$ECR_REGISTRY/airship:$PREV_TAG"
docker stop airship || true && docker rm airship || true
docker run -d --name airship --restart unless-stopped \
  -p 80:3000 \
  --env-file /home/ec2-user/.env \
  -v /home/ec2-user/data:/app/data \
  "$ECR_REGISTRY/airship:$PREV_TAG"
```

**Triggers**: health check failing for 5+ minutes / 5xx spike after deploy / migration failure at startup

---

## 5. API Token Rotation

1. Create a new token on the **Tokens** page
2. Update CI/CD secrets with the new token
3. Confirm normal operation, then **Revoke** the old token

> Tokens are displayed **only once** at creation. Save to secrets immediately.

---

## 6. App Cleanup

To remove an app that is no longer in use:

1. Click **Delete App** on the app detail page
2. Confirm in the dialog

> All DB data (updates, channels, assignments, assets, rollback history) is cascade-deleted.
> S3 objects are **not** automatically removed â€” clean up the bucket manually if needed.
