# Staging Verification Checklist

Items to verify in the staging environment before deploying a new version.

---

## 1. Migration

```bash
bun run db:migrate
```

- Confirm `channel_assignments` table has a `platform` column
- Confirm `api_tokens` table exists

---

## 2. Automated Tests

```bash
bun run test:integration
bun run verify:platform
```

- API validation tests pass
- Platform uniqueness constraint test passes

---

## 3. Cross-Platform Deployment

Deploy **iOS and Android separately** to the same `appKey` / `runtimeVersion` / `channel`.

1. Upload an iOS update to `staging`
2. Upload an Android update to `staging`
3. Request the manifest with each platform header

```bash
# iOS
curl -i -X POST "https://<host>/api/apps/<appKey>/manifest" \
  -H "expo-platform: ios" \
  -H "expo-runtime-version: 1.0.0" \
  -H "expo-channel-name: staging"

# Android
curl -i -X POST "https://<host>/api/apps/<appKey>/manifest" \
  -H "expo-platform: android" \
  -H "expo-runtime-version: 1.0.0" \
  -H "expo-channel-name: staging"
```

**Verify**:
- iOS request &rarr; returns the iOS bundle
- Android request &rarr; returns the Android bundle
- Deploying one platform does not overwrite the other

---

## 4. Update Toggle

1. Click **Disable Update** on the Update detail page
2. Request the manifest for the assigned channel &rarr; confirm the disabled update is **not included**
3. Click **Enable Update** to restore, then confirm a normal response

---

## 5. Rollout Percentage

1. On the Channels page, click the percentage &rarr; change to `50` &rarr; Save
2. Request the manifest multiple times under the same conditions
3. Confirm that roughly half of the requests return the update
4. Restore to `100`

---

## 6. API Tokens

1. Create a token on the **Tokens** page (the plaintext is shown only once)
2. Test authentication with the created token

```bash
# Valid token → 200
curl -H "Authorization: Bearer airship_xxxx..." \
  https://<host>/api/apps

# Invalid token → 401
curl -H "Authorization: Bearer invalid_token" \
  https://<host>/api/apps
```

3. Confirm the **Last used** timestamp updated on the Tokens page

---

## 7. App Deletion

> **Only perform this on test apps.**

1. Create a test app with updates and channel assignments
2. Click **Delete App** on the app detail page
3. Confirm all related data (updates, channels, assignments, assets, rollback history) has been removed

---

## 8. DB Sanity Check

```sql
-- Verify platform-specific assignments are separated
SELECT app_id, channel_id, runtime_version, platform, update_id
FROM channel_assignments
WHERE app_id = '<app-id>' AND runtime_version = '1.0.0'
ORDER BY platform;
-- Expected: one row for ios, one row for android

-- Verify tokens (plaintext is never stored)
SELECT id, name, created_at, last_used_at
FROM api_tokens;
```
