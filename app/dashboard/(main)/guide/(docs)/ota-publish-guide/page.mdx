# OTA Publish Guide

## Publish Flow

```
Bundle build → publish-update.sh → auto-assigned to staging → promote to production on dashboard
```

## Prerequisites

### Required Tools

- `curl`
- `jq`
- `shasum` (macOS) or `sha256sum` (Linux)

### Environment Variables

| Variable | Description | Required |
|------|------|------|
| `AIRSHIP_ADMIN_SECRET` | Bearer token for API authentication | Yes |
| `AIRSHIP_SERVER_URL` | Airship server URL | When `--server` is not specified |

## Manual Deploy (Local)

### 1. Export Expo Bundle

```bash
npx expo export --platform ios --output-dir dist
```

### 2. Publish OTA Update

```bash
export AIRSHIP_ADMIN_SECRET="your-admin-secret"

./scripts/publish-update.sh \
  --server https://ota.example.com \
  --app-key my-app \
  --runtime-version 1.0.0 \
  --platform ios \
  --bundle ./dist/bundles/ios-xxxxx.js
```

The default channel is `staging`. Use `--channel` to deploy to a different channel.

### 3. Promote on Dashboard

1. Go to Dashboard → App → Update detail page
2. The currently assigned channel is shown as a badge
3. In the Promote section, select staging → production and click Promote

## App Repo CI Integration

Call `publish-update.sh` directly from GitHub Actions in the app repo after building the bundle.

### 1. Secrets Configuration

Add the following in the app repo under Settings → Secrets and variables → Actions:

- `AIRSHIP_ADMIN_SECRET` — API authentication token
- `AIRSHIP_SERVER_URL` — Airship server URL

### 2. Workflow Example

```yaml
# .github/workflows/ota-publish.yml (add to app repo)
name: OTA Publish
on:
  push:
    branches: [main]

jobs:
  publish:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [ios, android]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install & Export
        run: |
          npm ci
          npx expo export \
            --platform ${{ matrix.platform }} \
            --output-dir dist

      - name: Download publish script
        run: |
          curl -sfO ${{ secrets.AIRSHIP_SERVER_URL }}/publish-update.sh \
            || curl -sfO https://raw.githubusercontent.com/<org>/airship/main/scripts/publish-update.sh
          chmod +x publish-update.sh

      - name: Publish OTA
        env:
          AIRSHIP_ADMIN_SECRET: ${{ secrets.AIRSHIP_ADMIN_SECRET }}
          AIRSHIP_SERVER_URL: ${{ secrets.AIRSHIP_SERVER_URL }}
        run: |
          ./publish-update.sh \
            --app-key my-app \
            --runtime-version 1.0.0 \
            --platform ${{ matrix.platform }} \
            --bundle dist/bundles/${{ matrix.platform }}.js
```

iOS/Android run in parallel via the matrix strategy. The default channel is `staging` — promote to production from the dashboard.

## Script Options

```bash
./scripts/publish-update.sh --help
```

| Option | Description | Default |
|------|------|--------|
| `--server URL` | Airship server URL | `$AIRSHIP_SERVER_URL` |
| `--app-key KEY` | App key | (required) |
| `--runtime-version VER` | Runtime version | (required) |
| `--platform PLATFORM` | ios or android | (required) |
| `--bundle PATH` | Bundle file path | (required) |
| `--channel NAME` | Target channel | staging |
