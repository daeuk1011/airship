# OTA Publish Guide

Use this guide when you already completed **Quick Start** and want repeatable OTA publishing.

- First time user: go to **Quick Start (10 min)**.
- This page: daily publish flow and CI automation.

---

## Fast Path (Most Common)

```bash
export AIRSHIP_ADMIN_SECRET="airship_xxx..."
export AIRSHIP_SERVER_URL="https://ota.example.com"

npx expo export --platform ios --output-dir dist

./scripts/publish-update.sh \
  --app-key my-app \
  --runtime-version 1.0.0 \
  --platform ios \
  --bundle ./dist/bundles/ios-xxxxx.js
```

Then promote on dashboard: `staging -> production`.

---

## Required Inputs

| Input | Example | Notes |
|---|---|---|
| `AIRSHIP_ADMIN_SECRET` | `airship_xxx...` | API token recommended |
| `AIRSHIP_SERVER_URL` | `https://ota.example.com` | Base URL |
| `--app-key` | `my-app` | Must exist in Dashboard |
| `--runtime-version` | `1.0.0` | Must match client runtime |
| `--platform` | `ios` / `android` | One platform per command |
| `--bundle` | `./dist/bundles/...js` | Exported bundle path |

---

## Script Reference

```bash
./scripts/publish-update.sh --help
```

| Option | Description | Default |
|---|---|---|
| `--server URL` | Airship server URL | `$AIRSHIP_SERVER_URL` |
| `--app-key KEY` | App key | required |
| `--runtime-version VER` | Runtime version | required |
| `--platform PLATFORM` | `ios` or `android` | required |
| `--bundle PATH` | Bundle file path | required |
| `--channel NAME` | Target channel | `staging` |

---

## CI Automation (GitHub Actions)

Use matrix to publish iOS and Android in parallel.

```yaml
name: OTA Publish
on:
  push:
    branches: [main]

jobs:
  publish:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [ios, android]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: |
          npm ci
          npx expo export --platform ${{ matrix.platform }} --output-dir dist

      - run: |
          curl -sfO ${{ secrets.AIRSHIP_SERVER_URL }}/publish-update.sh
          chmod +x publish-update.sh

      - env:
          AIRSHIP_ADMIN_SECRET: ${{ secrets.AIRSHIP_ADMIN_SECRET }}
          AIRSHIP_SERVER_URL: ${{ secrets.AIRSHIP_SERVER_URL }}
        run: |
          ./publish-update.sh \
            --app-key my-app \
            --runtime-version 1.0.0 \
            --platform ${{ matrix.platform }} \
            --bundle dist/bundles/${{ matrix.platform }}.js
```

---

## Troubleshooting

- `401 Unauthorized`: token missing/invalid/revoked.
- `App not found`: wrong app key.
- `Bundle not found on S3`: upload URL expired or wrong key in commit.
- `no such table: api_tokens`: server migration is not applied.

---

## Next

- Validation before release: **Staging Verification Checklist**
- Operations and incidents: **Production Operations Checklist**
