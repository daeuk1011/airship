# OTA Publish Guide

End-to-end workflow from bundle export to production deployment.

---

## Publish Flow

> **Bundle Export** &rarr; **publish-update.sh** &rarr; **Auto-assigned to staging** &rarr; **Promote to production on dashboard**

---

## Prerequisites

**Tools**: `curl`, `jq`, `shasum` (macOS) or `sha256sum` (Linux)

**Authentication** — two methods are supported:

- **Admin Secret** (`Bearer <ADMIN_SECRET>`) — for local development and initial setup
- **API Token** (`Bearer airship_xxx...`) — for CI/CD and automation **(recommended)**

Create API Tokens on the **Tokens** page in the dashboard.

**Environment Variables**:

- `AIRSHIP_ADMIN_SECRET` — Bearer token (Admin Secret or API Token)
- `AIRSHIP_SERVER_URL` — Airship server URL (used when `--server` is not specified)

---

## Manual Deploy (Local)

### Step 1. Export Expo Bundle

```bash
npx expo export --platform ios --output-dir dist
npx expo export --platform android --output-dir dist
```

### Step 2. Publish OTA Update

```bash
export AIRSHIP_ADMIN_SECRET="your-token"

./scripts/publish-update.sh \
  --server https://ota.example.com \
  --app-key my-app \
  --runtime-version 1.0.0 \
  --platform ios \
  --bundle ./dist/bundles/ios-xxxxx.js
```

> Default channel is `staging`. Use `--channel production` to target a different channel.

### Step 3. Promote on Dashboard

1. Go to **App** &rarr; click the update in the Updates list
2. The currently assigned channel is shown as a badge
3. In the **Promote** section, select `staging → production` and click Promote

---

## CI Integration (GitHub Actions)

Automatically publish OTA updates after building the bundle in your app repo.

### Secrets Setup

Add the following in your app repo under Settings &rarr; Secrets and variables &rarr; Actions:

- `AIRSHIP_ADMIN_SECRET` — API Token
- `AIRSHIP_SERVER_URL` — Airship server URL

### Workflow Example

```yaml
# .github/workflows/ota-publish.yml (add to app repo)
name: OTA Publish
on:
  push:
    branches: [main]

jobs:
  publish:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [ios, android]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install & Export
        run: |
          npm ci
          npx expo export \
            --platform ${{ matrix.platform }} \
            --output-dir dist

      - name: Download publish script
        run: |
          curl -sfO ${{ secrets.AIRSHIP_SERVER_URL }}/publish-update.sh \
            || curl -sfO https://raw.githubusercontent.com/<org>/airship/main/scripts/publish-update.sh
          chmod +x publish-update.sh

      - name: Publish OTA
        env:
          AIRSHIP_ADMIN_SECRET: ${{ secrets.AIRSHIP_ADMIN_SECRET }}
          AIRSHIP_SERVER_URL: ${{ secrets.AIRSHIP_SERVER_URL }}
        run: |
          ./publish-update.sh \
            --app-key my-app \
            --runtime-version 1.0.0 \
            --platform ${{ matrix.platform }} \
            --bundle dist/bundles/${{ matrix.platform }}.js
```

> iOS and Android run in parallel via the `matrix` strategy.
> Default channel is `staging` — promote to production from the dashboard.

---

## Script Options Reference

| Option | Description | Default |
|---|---|---|
| `--server URL` | Airship server URL | `$AIRSHIP_SERVER_URL` |
| `--app-key KEY` | App key | *required* |
| `--runtime-version VER` | Runtime version | *required* |
| `--platform PLATFORM` | `ios` or `android` | *required* |
| `--bundle PATH` | Bundle file path | *required* |
| `--channel NAME` | Target channel | `staging` |

---

## Dashboard Features After Deployment

| Feature | Location | Description |
|---|---|---|
| **Grouped View** | App detail | View iOS + Android pairs grouped together |
| **Bundle Size** | App detail / Update detail | Bundle size for each update |
| **Runtime Versions** | App detail | Update count and channel assignment status per RV |
| **Enable / Disable** | Update detail | Disable an update to immediately stop delivery |
| **Rollout %** | Channels page | Gradual rollout from 0% to 100% |
