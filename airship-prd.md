# Self-Hosted Expo Updates Server PRD

**No Custom Domain Edition**

Version 1.0 | February 2026

---

## 1. Context

EAS Update is a paid SaaS service from Expo. This document defines the requirements for a self-hosted alternative that implements the Expo Updates Protocol, enabling OTA (Over-The-Air) updates without dependency on EAS infrastructure.

Key constraints for the initial version:

- No custom domain required. Uses EC2 public IP or AWS default DNS for the API server.
- Assets served via S3 default URL or CloudFront default domain.
- Architecture designed for future domain addition without restructuring.
- Single Next.js instance supporting multiple apps simultaneously.

---

## 2. System Architecture

The system consists of three components connected in a simple pipeline:

```
Expo App (expo-updates client)
  │
  │ POST http://<EC2-IP>:3000/api/apps/:appKey/manifest
  │ Headers: expo-platform, expo-runtime-version, expo-channel-name
  ▼
Next.js OTA Server (EC2)
  ├─ SQLite DB (Drizzle ORM) : update metadata, channel assignments
  ├─ Update Selection Engine : runtime version + channel + platform matching
  ├─ Manifest Builder        : generates protocol-compliant JSON response
  │
  │ S3 presigned URLs in manifest
  ▼
AWS S3 Bucket
  ├─ bundles/   : JS bundles per platform
  └─ assets/    : images, fonts, etc.
```

### Core Principles

- Single Next.js instance serves both the OTA API and the admin dashboard.
- Single SQLite database file on EBS (gp3) with WAL mode enabled.
- Single S3 bucket with prefix-based app separation.
- Multi-app support via appKey path parameter.
- Fully operational without a custom domain.

---

## 3. Network Configuration (No Domain)

### 3.1 API Server Access

The API server is accessible via the EC2 instance's public IP or AWS-assigned DNS:

```
http://<EC2-PUBLIC-IP>:3000
http://ec2-xx-xx-xx-xx.ap-northeast-2.compute.amazonaws.com:3000
```

> HTTPS is recommended for production. For internal testing and early-stage deployment, HTTP is acceptable. When HTTPS is needed, options include an ALB with ACM certificate or a reverse proxy with Let's Encrypt.

### 3.2 Asset Access

Assets are served directly from S3 using presigned URLs generated by the server. Clients never need to know the bucket structure; the manifest contains fully-formed download URLs.

```
https://s3.ap-northeast-2.amazonaws.com/<bucket>/ota/<appKey>/<runtimeVersion>/<updateGroupId>/bundles/ios/index.bundle
https://<bucket>.s3.ap-northeast-2.amazonaws.com/ota/<appKey>/...
```

### 3.3 Expo App Configuration

In `app.json` (or `app.config.js`), the app points to the self-hosted server:

```json
{
  "expo": {
    "runtimeVersion": "1.0.0",
    "updates": {
      "url": "http://<EC2-IP>:3000/api/apps/vowly/manifest",
      "enabled": true,
      "checkAutomatically": "ON_LOAD"
    }
  }
}
```

---

## 4. Multi-App Strategy

All apps share a single server and S3 bucket, separated by the appKey identifier.

### 4.1 API Routing

Every API endpoint is scoped under the appKey path:

```
POST /api/apps/:appKey/manifest              # Client update check
POST /api/apps/:appKey/uploads/presign        # Get presigned upload URLs
POST /api/apps/:appKey/uploads/commit         # Finalize upload
POST /api/apps/:appKey/updates/:id/rollback   # Rollback
POST /api/apps/:appKey/updates/:id/promote    # Promote to another channel
GET  /api/apps/:appKey/updates                # List updates
GET  /api/apps/:appKey/channels               # List channels
```

Examples:

```
/api/apps/vowly/manifest
/api/apps/catchview/manifest
```

### 4.2 S3 Bucket Structure

```
ota/
  {appKey}/
    {runtimeVersion}/
      {updateGroupId}/
        bundles/
          ios/index.bundle
          android/index.bundle
        assets/
          {hash}.png
          {hash}.otf
          ...
```

This structure ensures complete isolation between apps, runtime versions, and individual updates within a single bucket.

---

## 5. Database Schema (SQLite + Drizzle ORM)

Six tables manage the update lifecycle. All IDs are UUID v4 strings. Timestamps are stored as Unix milliseconds.

### 5.1 apps

Registered applications.

| Column | Type | Constraint | Description |
|--------|------|------------|-------------|
| `id` | TEXT | PK | UUID v4 |
| `appKey` | TEXT | UNIQUE | App identifier used in URL paths (e.g. 'vowly') |
| `name` | TEXT | NOT NULL | Display name |
| `createdAt` | INTEGER | NOT NULL | Unix ms timestamp |

### 5.2 channels

Deployment channels per app (production, staging, preview, etc).

| Column | Type | Constraint | Description |
|--------|------|------------|-------------|
| `id` | TEXT | PK | UUID v4 |
| `appId` | TEXT | FK apps.id | Parent application |
| `name` | TEXT | NOT NULL | Channel name (e.g. 'production') |
| `createdAt` | INTEGER | NOT NULL | Unix ms timestamp |

> Unique constraint: `(appId, name)`

### 5.3 updates

Each record represents a single platform build within an update group.

| Column | Type | Constraint | Description |
|--------|------|------------|-------------|
| `id` | TEXT | PK | UUID v4. This becomes the manifest `id`. |
| `appId` | TEXT | FK apps.id | Parent application |
| `updateGroupId` | TEXT | NOT NULL | Groups iOS + Android builds from the same `expo export` |
| `runtimeVersion` | TEXT | NOT NULL | Exact runtime version string (e.g. '1.0.3') |
| `platform` | TEXT | NOT NULL | 'ios' or 'android' |
| `bundleS3Key` | TEXT | NOT NULL | S3 key of the JS bundle file |
| `bundleHash` | TEXT | NOT NULL | SHA-256 hash of the bundle |
| `bundleSize` | INTEGER | | Bundle file size in bytes |
| `enabled` | INTEGER | DEFAULT 1 | Boolean. 0 = disabled (soft delete). |
| `createdAt` | INTEGER | NOT NULL | Unix ms timestamp |

> Indexes: `(appId, runtimeVersion, platform, createdAt)`, `(updateGroupId)`

### 5.4 assets

Individual files (images, fonts, data) belonging to an update.

| Column | Type | Constraint | Description |
|--------|------|------------|-------------|
| `id` | TEXT | PK | UUID v4 |
| `updateId` | TEXT | FK updates.id | Parent update |
| `s3Key` | TEXT | NOT NULL | Full S3 object key |
| `hash` | TEXT | NOT NULL | SHA-256 hash |
| `key` | TEXT | NOT NULL | Asset key (filename identifier) |
| `fileExtension` | TEXT | NOT NULL | e.g. '.png', '.otf' |
| `contentType` | TEXT | | MIME type |
| `size` | INTEGER | | File size in bytes |

### 5.5 channelAssignments

Maps which update is currently live on each channel for a given runtime version. This is the core pointer that the manifest endpoint reads. Changing this pointer is how deployments and rollbacks work.

| Column | Type | Constraint | Description |
|--------|------|------------|-------------|
| `id` | TEXT | PK | UUID v4 |
| `appId` | TEXT | FK apps.id | Parent application |
| `channelId` | TEXT | FK channels.id | Target channel |
| `updateId` | TEXT | FK updates.id | Currently assigned update |
| `runtimeVersion` | TEXT | NOT NULL | Scoped to this runtime version |
| `rolloutPercent` | REAL | DEFAULT 100 | 0-100. Percentage of devices receiving this update. |
| `updatedAt` | INTEGER | NOT NULL | Last modification timestamp |

> Unique constraint: `(appId, channelId, runtimeVersion)` — one active update per channel per runtime version.

### 5.6 rollbackHistory

Audit trail for all rollback operations.

| Column | Type | Constraint | Description |
|--------|------|------------|-------------|
| `id` | TEXT | PK | UUID v4 |
| `appId` | TEXT | FK apps.id | Parent application |
| `channelId` | TEXT | FK channels.id | Target channel |
| `fromUpdateId` | TEXT | FK updates.id | Update being rolled back from |
| `toUpdateId` | TEXT | FK updates.id | Update being rolled back to |
| `reason` | TEXT | | Optional rollback reason |
| `createdAt` | INTEGER | NOT NULL | Rollback timestamp |

---

## 6. Manifest Flow (Expo Updates Protocol)

This is the core endpoint. It must comply with the Expo Updates Protocol v1 so that the expo-updates client library can communicate with it seamlessly.

### 6.1 Client Request

```
POST /api/apps/:appKey/manifest

Headers:
  expo-platform: ios                      # Required. 'ios' or 'android'
  expo-runtime-version: 1.0.3             # Required. Must match exactly.
  expo-channel-name: production            # Optional. Defaults to 'production'.
  expo-protocol-version: 1                 # Protocol version
  expo-expect-signature: (optional)        # For code signing verification
```

### 6.2 Server Processing Logic

1. **Resolve appKey** to the apps table. Return 404 if not found.
2. **Resolve channel name** (from header) to the channels table for this app.
3. **Look up channelAssignment** matching (appId, channelId, runtimeVersion).
4. **Apply rollout percentage.** Hash the client identifier to deterministically decide if this device is within the rollout window.
5. **Load the update record** and its assets. Filter by matching platform.
6. **Generate presigned S3 URLs** for the bundle and all assets (10-minute expiry).
7. **Build and return the manifest JSON.**

### 6.3 Response Format

#### 200 OK — Update Available

```
Response Headers:
  expo-protocol-version: 1
  expo-sfv-version: 0
  content-type: application/json
```

```json
{
  "id": "a1b2c3d4-...",
  "createdAt": "2026-02-12T10:30:00.000Z",
  "runtimeVersion": "1.0.3",
  "launchAsset": {
    "hash": "sha256-abc123...",
    "key": "bundle",
    "fileExtension": ".bundle",
    "contentType": "application/javascript",
    "url": "https://s3.../ota/vowly/1.0.3/.../bundles/ios/index.bundle?X-Amz-..."
  },
  "assets": [
    {
      "hash": "sha256-def456...",
      "key": "asset-key-001",
      "fileExtension": ".png",
      "contentType": "image/png",
      "url": "https://s3.../ota/vowly/1.0.3/.../assets/def456.png?X-Amz-..."
    }
  ],
  "metadata": {
    "branchName": "production"
  }
}
```

#### 204 No Content — No Update Available

Returned when no matching update exists for the given channel, runtime version, and platform combination. Also returned when the client is outside the rollout percentage window.

```
Response Headers:
  expo-protocol-version: 1

Response Body: (empty)
```

#### 400 Bad Request

Returned when required headers are missing or invalid.

```json
{ "error": "Missing expo-platform header" }
```

#### 404 Not Found

Returned when the appKey does not exist.

> **Note:** A missing runtimeVersion match is NOT a 404 or 409. It is a 204 (no update available). The expo-updates client expects 204 for "nothing new" situations.

---

## 7. Upload Flow (Presigned URL)

Uploads use a two-phase approach: the client obtains presigned URLs from the server, uploads directly to S3, then commits the metadata to the database. This avoids routing large files through the API server.

### 7.1 Step 1: Request Presigned URLs

```
POST /api/apps/:appKey/uploads/presign
Authorization: Bearer <ADMIN_SECRET>
Content-Type: application/json
```

```json
{
  "runtimeVersion": "1.0.3",
  "platform": "ios",
  "bundleFilename": "index.bundle",
  "assets": [
    { "filename": "abc123.png", "contentType": "image/png" },
    { "filename": "def456.otf", "contentType": "font/otf" }
  ]
}
```

**Response:**

```json
{
  "updateGroupId": "grp-uuid-...",
  "bundle": {
    "s3Key": "ota/vowly/1.0.3/grp-uuid/bundles/ios/index.bundle",
    "presignedUrl": "https://s3.../ota/vowly/...?X-Amz-Algorithm=..."
  },
  "assets": [
    {
      "filename": "abc123.png",
      "s3Key": "ota/vowly/1.0.3/grp-uuid/assets/abc123.png",
      "presignedUrl": "https://s3.../...?X-Amz-..."
    }
  ]
}
```

### 7.2 Step 2: Upload to S3

The client uploads each file directly to S3 using the presigned URLs via HTTP PUT. This happens client-side (e.g. from a CI/CD pipeline or a CLI tool).

```
PUT <presignedUrl>
Content-Type: application/javascript
Body: <file binary>
```

### 7.3 Step 3: Commit

After all files are uploaded, the client commits the metadata:

```
POST /api/apps/:appKey/uploads/commit
Authorization: Bearer <ADMIN_SECRET>
Content-Type: application/json
```

```json
{
  "updateGroupId": "grp-uuid-...",
  "runtimeVersion": "1.0.3",
  "platform": "ios",
  "channelName": "staging",
  "bundle": {
    "s3Key": "ota/vowly/1.0.3/grp-uuid/bundles/ios/index.bundle",
    "hash": "sha256-abc123...",
    "size": 524288
  },
  "assets": [
    {
      "s3Key": "ota/vowly/1.0.3/grp-uuid/assets/abc123.png",
      "hash": "sha256-def456...",
      "key": "asset-key-001",
      "fileExtension": ".png",
      "contentType": "image/png",
      "size": 12345
    }
  ]
}
```

**Server processing on commit:**

1. Verify all files exist on S3 (HeadObject check).
2. Insert update record into the updates table.
3. Insert all asset records into the assets table.
4. Update channelAssignment to point to the new update (UPSERT on unique constraint).
5. Return 201 with the created update ID.

---

## 8. Rollback Flow

```
POST /api/apps/:appKey/updates/:targetUpdateId/rollback
Authorization: Bearer <ADMIN_SECRET>
Content-Type: application/json

{ "channelName": "production", "reason": "Critical bug in v2.1" }
```

Rollback is a pointer change, not a data copy. The server:

1. Verifies the target update exists and is compatible (same appId and runtimeVersion).
2. Reads the current channelAssignment to record what we are rolling back from.
3. Updates the channelAssignment to point to the target update.
4. Inserts a record into rollbackHistory for audit.
5. Returns 200 with the rollback details.

> **Important:** Old bundles must NOT be deleted from S3. They must remain available for rollback. Implement a retention policy (e.g., keep last N updates or last 90 days) as a separate maintenance task.

---

## 9. Promote Flow (Staging → Production)

업데이트는 기본적으로 `staging` 채널에 배포된다. 검증 후 대시보드 또는 API를 통해 `production`으로 승격(promote)한다. 승격은 새 빌드가 아닌 기존 업데이트의 channelAssignment 포인터를 복사하는 방식이다.

### 9.1 Promote API

```
POST /api/apps/:appKey/updates/:updateId/promote
Authorization: Bearer <ADMIN_SECRET>
Content-Type: application/json
```

```json
{
  "fromChannel": "staging",
  "toChannel": "production",
  "rolloutPercent": 100
}
```

**Server processing:**

1. Verify the update exists and is currently assigned to `fromChannel`.
2. Look up (or create) the `toChannel` channelAssignment for the same runtimeVersion.
3. Point `toChannel` channelAssignment to the same updateId.
4. Set rolloutPercent (defaults to 100 if omitted).
5. Return 200 with the updated assignment.

**Response:**

```json
{
  "promoted": true,
  "updateId": "a1b2c3d4-...",
  "fromChannel": "staging",
  "toChannel": "production",
  "runtimeVersion": "1.0.3",
  "rolloutPercent": 100
}
```

> **Gradual Rollout:** `rolloutPercent`를 10 → 50 → 100으로 단계적으로 올려 카나리 배포가 가능하다. 같은 promote 엔드포인트에 percent만 변경하여 재호출하면 된다.

### 9.2 Deployment Policy

- CI/CD (GitHub Actions)가 main 브랜치 push 시 자동으로 번들을 빌드하고 `staging`에 배포한다.
- 대시보드에서 staging 업데이트를 확인한 후 Promote 버튼으로 production에 승격한다.
- 문제 발생 시 Rollback API로 이전 업데이트로 즉시 전환한다.
- 하나의 빌드 파이프라인만 운영하되, 배포 타이밍은 대시보드에서 제어한다.

---

## 10. Security

### 10.1 Authentication

- **Manifest endpoint (POST /api/apps/:appKey/manifest):** No authentication. This is called by end-user devices and must be publicly accessible.
- **All other endpoints:** Require `Authorization: Bearer <ADMIN_SECRET>` header. The secret is stored in environment variables.

### 10.2 S3 Access Control

- Bucket is private (no public access).
- Server IAM role has `s3:PutObject` and `s3:GetObject` scoped to the `ota/` prefix.
- Upload presigned URLs have a 15-minute expiry.
- Download presigned URLs (in manifest) have a 10-minute expiry.

### 10.3 Database

- SQLite WAL mode enabled for concurrent read performance.
- DB file stored on EBS (gp3) with daily backup to S3.
- Write operations are serialized by SQLite (single writer).

### 10.4 Future: Code Signing

Expo Updates Protocol supports code signing to verify update integrity. This is not required for the initial version but should be added before production-critical deployment. When implemented, the server signs the manifest with a private key, and the client verifies using the corresponding public key embedded in the app binary.

---

## 11. Admin Dashboard

A web UI served from the same Next.js instance at `/dashboard`. Requires admin authentication.

### 11.1 Pages

- **Overview:** Summary stats (total apps, updates, active channels, S3 usage).
- **Apps:** List registered apps, create new apps.
- **Updates:** Per-app list of updates with channel, runtime version, platform, status, and creation date. Link to detail view.
- **Update Detail:** Manifest JSON viewer, asset list, rollback button with confirmation.
- **Upload:** Form to trigger upload flow (or instructions for CLI-based upload).
- **Channels:** Per-app channel management. View current assignment per runtime version.
- **Rollback History:** Audit log of all rollback operations.

---

## 12. Environment Variables

| Variable | Example | Description |
|----------|---------|-------------|
| `DATABASE_URL` | `file:./data/ota.db` | SQLite database path |
| `AWS_REGION` | `ap-northeast-2` | AWS region |
| `AWS_S3_BUCKET` | `my-ota-bucket` | S3 bucket name |
| `AWS_ACCESS_KEY_ID` | `AKIA...` | IAM access key (or use EC2 instance role) |
| `AWS_SECRET_ACCESS_KEY` | `...` | IAM secret key |
| `ADMIN_SECRET` | `random-string` | Bearer token for admin API authentication |
| `PRESIGNED_URL_EXPIRY` | `600` | Download presigned URL expiry in seconds |
| `UPLOAD_URL_EXPIRY` | `900` | Upload presigned URL expiry in seconds |

---

## 13. Operational Strategy

### 13.1 Initial Deployment

- Single EC2 instance (t3.small or equivalent). 1 vCPU, 2GB RAM is sufficient for thousands of users.
- SQLite database on EBS gp3 volume.
- Single S3 bucket with prefix-based app separation.
- Process manager: PM2 or systemd for auto-restart.
- Daily DB backup: cron job that copies the SQLite file to S3.

### 13.2 S3 Storage Lifecycle

빌드가 누적되면 S3 비용이 증가하므로 3단계 수명주기 정책을 적용한다.

| 기간 | Storage Class | 설명 |
|------|---------------|------|
| 0–30일 | Standard | 활성 배포 + 즉시 롤백 대상. 빠른 접근 필요. |
| 30–90일 | Standard-IA (Infrequent Access) | 롤백 가능하나 접근 빈도 낮음. 비용 약 45% 절감. |
| 90일+ | Glacier Instant Retrieval 또는 삭제 | 거의 접근하지 않음. 필요시 ms 단위 복원 가능. |

**Safety Rule:** `channelAssignments`에 현재 할당된 업데이트의 에셋은 수명주기 정책에서 제외한다. 활성 배포 중인 번들이 삭제 또는 전환되는 것을 방지하기 위해, 삭제/전환 전에 DB의 channelAssignment 테이블을 조회하여 참조 중인 S3 prefix를 보호한다.

**구현 방식:**

- S3 Lifecycle Rule을 `ota/` prefix에 적용.
- 일별 cron job이 현재 활성 channelAssignment가 참조하는 S3 key 목록을 수집.
- 해당 key에 `active=true` 태그를 부여하고, Lifecycle Rule에서 `active=true` 태그가 있는 객체는 전환/삭제에서 제외.

### 13.3 Scaling Path

- Add CloudFront in front of S3 for global asset distribution.
- Add a custom domain + HTTPS (ALB with ACM or Nginx + Let's Encrypt).
- Migrate SQLite to PostgreSQL when write concurrency becomes a bottleneck.
- Horizontal API scaling behind ALB (requires PostgreSQL migration first).
- Add Redis for manifest response caching if latency is critical.

---

## 14. CI/CD Pipeline (GitHub Actions)

main 브랜치에 push되면 GitHub Actions가 자동으로 번들을 빌드하고 staging 채널에 배포한다. production 배포는 대시보드 Promote 버튼으로만 수행한다.

### 14.1 Workflow

```yaml
name: OTA Update Deploy

on:
  push:
    branches: [main]

env:
  OTA_SERVER_URL: ${{ secrets.OTA_SERVER_URL }}
  ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
  APP_KEY: vowly

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [ios, android]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - name: Export bundle
        run: npx expo export --platform ${{ matrix.platform }} --output-dir dist/${{ matrix.platform }}

      - name: Get runtime version
        id: runtime
        run: echo "version=$(node -e \"console.log(require('./app.json').expo.runtimeVersion)\")" >> $GITHUB_OUTPUT

      - name: Request presigned URLs
        id: presign
        run: |
          BUNDLE_FILE="dist/${{ matrix.platform }}/bundles/${{ matrix.platform }}/index.bundle"
          ASSETS=$(find dist/${{ matrix.platform }}/assets -type f | jq -R -s 'split("\n") | map(select(length > 0)) | map({filename: (split("/") | last), contentType: "application/octet-stream"})' )

          RESPONSE=$(curl -s -X POST "$OTA_SERVER_URL/api/apps/$APP_KEY/uploads/presign" \
            -H "Authorization: Bearer $ADMIN_SECRET" \
            -H "Content-Type: application/json" \
            -d "{
              \"runtimeVersion\": \"${{ steps.runtime.outputs.version }}\",
              \"platform\": \"${{ matrix.platform }}\",
              \"bundleFilename\": \"index.bundle\",
              \"assets\": $ASSETS
            }")

          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

      - name: Upload files to S3
        run: |
          # Upload bundle
          BUNDLE_URL=$(echo '${{ steps.presign.outputs.response }}' | jq -r '.bundle.presignedUrl')
          curl -s -X PUT "$BUNDLE_URL" \
            -H "Content-Type: application/javascript" \
            --data-binary @"dist/${{ matrix.platform }}/bundles/${{ matrix.platform }}/index.bundle"

          # Upload assets
          echo '${{ steps.presign.outputs.response }}' | jq -r '.assets[] | "\(.filename) \(.presignedUrl)"' | \
          while read filename url; do
            ASSET_PATH=$(find dist/${{ matrix.platform }}/assets -name "$filename" -type f)
            curl -s -X PUT "$url" --data-binary @"$ASSET_PATH"
          done

      - name: Commit to staging
        run: |
          # Build commit payload with hashes and sizes
          # ... (compute sha256 hashes for bundle and assets)
          curl -s -X POST "$OTA_SERVER_URL/api/apps/$APP_KEY/uploads/commit" \
            -H "Authorization: Bearer $ADMIN_SECRET" \
            -H "Content-Type: application/json" \
            -d "$COMMIT_PAYLOAD"
```

### 14.2 Required Secrets

| Secret | Description |
|--------|-------------|
| `OTA_SERVER_URL` | Self-hosted 서버 URL (e.g. `http://<EC2-IP>:3000`) |
| `ADMIN_SECRET` | 서버 admin API Bearer token |

### 14.3 Flow Summary

```
main push → GitHub Actions
  → expo export (iOS/Android 병렬)
  → presign API 호출 → presigned URL 수신
  → S3에 번들/에셋 직접 업로드
  → commit API 호출 (channelName: "staging")
  → staging 채널에 자동 배포 완료
  → 대시보드에서 확인 후 Promote → production
```

---

## 15. Testing Checklist

### API Verification

- [ ] GET /api/apps/:appKey/manifest returns 200 with server info.
- [ ] POST with valid headers returns 200 manifest JSON when update exists.
- [ ] POST with valid headers returns 204 when no update exists.
- [ ] POST with missing headers returns 400 with error message.
- [ ] POST with unknown appKey returns 404.
- [ ] runtimeVersion exact matching works correctly (no partial matches).
- [ ] Platform filtering: iOS device gets iOS bundle, Android gets Android bundle.
- [ ] Channel isolation: staging and production return different updates.

### Upload Verification

- [ ] Presign endpoint returns valid S3 presigned URLs.
- [ ] Files can be uploaded to S3 using presigned URLs.
- [ ] Commit creates update and asset records in DB.
- [ ] Commit updates channelAssignment automatically.
- [ ] New manifest request returns the newly uploaded update.

### Rollback Verification

- [ ] Rollback changes channelAssignment pointer.
- [ ] Manifest returns the rolled-back-to update after rollback.
- [ ] rollbackHistory records the operation.
- [ ] rolloutPercent produces consistent results for the same device.

### End-to-End Verification

- [ ] Expo development build with updates.url pointed to self-hosted server.
- [ ] App launches and checks for update (visible in server logs).
- [ ] Upload a new bundle, restart app, update is applied.
- [ ] Rollback, restart app, previous version is restored.

---

## 16. Summary

This PRD defines a self-hosted Expo OTA update server that:

- Operates without a custom domain (EC2 IP + S3 default URLs).
- Supports multiple apps on a single Next.js + SQLite + S3 stack.
- Implements the Expo Updates Protocol v1 for seamless expo-updates client compatibility.
- Provides presigned-URL-based upload flow to keep large files off the API server.
- Supports instant rollback via channel assignment pointer changes.
- Uses a staging → production promote flow for safe deployments with gradual rollout support.
- Automates builds via GitHub Actions CI/CD pipeline (main push → staging auto-deploy).
- Manages S3 costs with 3-tier lifecycle policy (Standard → IA → Glacier) with active assignment protection.
- Includes an admin dashboard for operational management.
- Is designed for future enhancement: custom domain, HTTPS, CloudFront CDN, PostgreSQL migration, code signing.

> *The initial version prioritizes simplicity and correctness over scalability. The architecture supports progressive enhancement without restructuring.*
